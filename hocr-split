#!/usr/bin/env python

# split an hOCR file into individual pages

import sys,os,string,re
import xml
from lxml import html, etree

################################################################
### main program
################################################################

def print_usage():
    sys.stderr.write("split a multipage hOCR file into single pages\n\n")
    sys.stderr.write("usage: %s file.html pattern\n" % sys.argv[0])
    sys.stderr.write("   where 'pattern' is something like 'base-%03d.html'\n")

if len(sys.argv)>1 and (sys.argv[1] == '-h' or sys.argv[1] == '--help'):
    print_usage()
    sys.exit(0)

if len(sys.argv)!=3:
    print_usage()
    sys.exit(1)

pattern = sys.argv[2]
assert re.search('%[0-9]*d',pattern)

stream = open(sys.argv[1])
doc = html.fromstring(stream.read())
pages = doc.xpath("//*[@class='ocr_page']")
assert pages!=[]

container = pages[0].getparent()
index = 1
for new_page in pages:
    container_pages = container.xpath("//*[@class='ocr_page']")
    for page in container_pages: container.remove(page)
    container.append(new_page)
    stream = open(pattern % index, "w")
    stream.write(etree.tostring(doc, pretty_print=True))
    stream.close()
    index += 1
